The second solution.

This one is written in Prolog.
I used SWI Prolog (http://www.swi-prolog.org).

Advantages:

* Far fewer lines of code
* The hierarchy is only specified once
* Highly readable

Disadvantages:

* Requires another platform.

Neutral:

* I am unsure of the performance difference from my first solution.
